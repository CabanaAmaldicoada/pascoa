<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Cabana Pascoa</title>

    <!-- 1. Detector de Erros (Para aparecer na tela) -->
    <style>
        #error-log {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: white; color: red;
            z-index: 9999; padding: 20px;
            font-family: monospace; font-size: 14px;
            overflow: auto; white-space: pre-wrap;
        }
    </style>
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            var errorBox = document.getElementById('error-log');
            errorBox.style.display = 'block';
            errorBox.innerText += "ERRO DETECTADO:\n" + message + "\nLinha: " + lineno + "\n\n";
        };
    </script>

    <!-- 2. Bibliotecas -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { blood: '#8a0b0b', darkbg: '#0f0505', gold: '#ffd700' },
                    fontFamily: { horror: ['Courier New', 'monospace'], noble: ['Georgia', 'serif'] }
                }
            }
        }
    </script>

    <style>
        body { background-color: #0f0505; color: #e8d7d7; }
        .glass-panel { background: rgba(20,0,0,0.8); border: 1px solid #8a0b0b; }
    </style>
</head>
<body>
    <!-- Caixa de Erro -->
    <div id="error-log"></div>

    <div id="root"></div>

    <script type="text/babel">
        
        // --- CUIDADO AQUI ---
        // Certifique-se de que não apagou chaves } ou vírgulas ,
        
        const firebaseConfig = {
         apiKey: "AIzaSyDrrCBqOWLl0Epl0SPZvQDtEfeSgIIkICo",
         authDomain: "cabanapascoa.firebaseapp.com",
         projectId: "cabanapascoa",
         storageBucket: "cabanapascoa.firebasestorage.app",
         messagingSenderId: "1041169514465",
         appId: "1:1041169514465:web:a65376b4dc52fd72791ca0
        };

        // --- FIM DA CONFIGURAÇÃO ---

        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            const db = firebase.firestore();
            const DOC_REF = db.collection('artifacts').document('easter_event').collection('public').document('data');

            const { useState, useEffect } = React;

            function App() {
                const [leaderboard, setLeaderboard] = useState([]);
                const [inputCode, setInputCode] = useState("");
                const [status, setStatus] = useState("");

                useEffect(() => {
                    try {
                        const unsubscribe = DOC_REF.onSnapshot((doc) => {
                            if (doc.exists) {
                                const data = doc.data();
                                const lbData = data.leaderboard || {};
                                const sorted = Object.values(lbData).sort((a, b) => b.score - a.score);
                                setLeaderboard(sorted);
                            }
                        }, (error) => {
                            console.error(error);
                            alert("Erro ao ler banco: " + error.message);
                        });
                        return () => unsubscribe();
                    } catch (e) {
                        alert("Erro no useEffect: " + e.message);
                    }
                }, []);

                const handleRedeem = async (e) => {
                    e.preventDefault();
                    if (!inputCode) return;
                    setStatus("loading");

                    try {
                        await db.runTransaction(async (transaction) => {
                            const doc = await transaction.get(DOC_REF);
                            if (!doc.exists) throw "Banco de dados não iniciado!";
                            
                            const data = doc.data();
                            const codes = data.active_codes || {};
                            const lb = data.leaderboard || {};
                            const code = inputCode.toUpperCase().trim();

                            if (codes[code]) {
                                const points = codes[code];
                                const userName = prompt(`Ganhou ${points} pts! Seu nome:`);
                                if(!userName) throw "Nome obrigatório";
                                
                                const userId = "web_" + userName.toLowerCase().replace(/\s/g, ''); 
                                const currentScore = lb[userId]?.score || 0;

                                lb[userId] = { name: userName, score: currentScore + points, source: 'site' };
                                delete codes[code];

                                transaction.update(DOC_REF, { active_codes: codes, leaderboard: lb });
                                return points;
                            } else {
                                throw "Código inválido!";
                            }
                        });
                        setStatus("success");
                        setInputCode("");
                        alert("PONTOS ADICIONADOS!");
                    } catch (error) {
                        alert(typeof error === 'string' ? error : error.message);
                    } finally {
                        setStatus("");
                    }
                };

                return (
                    <div className="min-h-screen flex flex-col items-center p-4">
                        <header className="text-center mt-8 mb-10">
                            <h1 className="text-4xl text-blood font-bold mb-2">PÁSCOA MACABRA</h1>
                            <p className="text-gold text-sm uppercase tracking-widest">Caça aos Ovos</p>
                        </header>

                        <div className="w-full max-w-md glass-panel p-6 rounded mb-8">
                            <h2 className="text-xl text-gold mb-4 text-center">Resgatar Código</h2>
                            <form onSubmit={handleRedeem} className="flex flex-col gap-4">
                                <input 
                                    type="text" 
                                    value={inputCode}
                                    onChange={(e) => setInputCode(e.target.value)}
                                    placeholder="CÓDIGO..." 
                                    className="bg-black border border-blood text-white p-3 text-center text-xl"
                                />
                                <button type="submit" disabled={status === "loading"} className="bg-blood text-white py-3 font-bold hover:bg-red-900">
                                    {status === "loading" ? "..." : "ENVIAR"}
                                </button>
                            </form>
                        </div>

                        <div className="w-full max-w-md glass-panel p-6 rounded">
                            <h2 className="text-xl text-gold mb-4 text-center">Placar</h2>
                            <div className="space-y-2">
                                {leaderboard.map((user, idx) => (
                                    <div key={idx} className="flex justify-between border-b border-gray-800 pb-2">
                                        <span className="text-white">#{idx+1} {user.name}</span>
                                        <span className="text-blood font-bold">{user.score}</span>
                                    </div>
                                ))}
                                {leaderboard.length === 0 && <div className="text-center text-gray-500">Vazio...</div>}
                            </div>
                        </div>
                    </div>
                );
            }

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
            
        } catch (err) {
            document.getElementById('error-log').style.display = 'block';
            document.getElementById('error-log').innerText += "ERRO GERAL:\n" + err.message;
        }
    </script>
</body>
</html>
